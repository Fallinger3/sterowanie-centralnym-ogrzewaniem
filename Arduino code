#include <WiFi.h>
#include <WiFiMulti.h>
#include <WebServer.h>
#include "time.h"
#include <Preferences.h>

WiFiMulti wifiMulti;

const char* ntpServer = "pool.ntp.org";
const long gmtOffset_sec = 3600;
const int daylightOffset_sec = 3600;

const int relayPin = 5;
bool relayState = false;
bool manualOverride = false;

Preferences prefs;
bool isAPMode = false;  // NOWA ZMIENNA ‚Äì true je≈õli dzia≈Ça w trybie AP

struct Schedule {
  int onHour;
  int onMinute;
  int offHour;
  int offMinute;
  bool days[7];
};

Schedule schedules[2];

WebServer server(80);
unsigned long lastNtpSync = 0;
const unsigned long ntpInterval = 10000;

// --- Zapis/odczyt ustawie≈Ñ ---
void saveSettings() {
  prefs.begin("co-setup", false);
  for (int i = 0; i < 2; i++) {
    String prefix = "schedule" + String(i);
    prefs.putInt((prefix + "onHour").c_str(), schedules[i].onHour);
    prefs.putInt((prefix + "onMinute").c_str(), schedules[i].onMinute);
    prefs.putInt((prefix + "offHour").c_str(), schedules[i].offHour);
    prefs.putInt((prefix + "offMinute").c_str(), schedules[i].offMinute);
    for (int d = 0; d < 7; d++) {
      prefs.putBool((prefix + "day" + String(d)).c_str(), schedules[i].days[d]);
    }
  }
  prefs.end();
}

void loadSettings() {
  prefs.begin("co-setup", true);
  schedules[0].onHour = prefs.getInt("schedule0onHour", 10);
  schedules[0].onMinute = prefs.getInt("schedule0onMinute", 0);
  schedules[0].offHour = prefs.getInt("schedule0offHour", 13);
  schedules[0].offMinute = prefs.getInt("schedule0offMinute", 0);

  schedules[1].onHour = prefs.getInt("schedule1onHour", 14);
  schedules[1].onMinute = prefs.getInt("schedule1onMinute", 0);
  schedules[1].offHour = prefs.getInt("schedule1offHour", 16);
  schedules[1].offMinute = prefs.getInt("schedule1offMinute", 0);

  for (int i = 0; i < 2; i++) {
    String prefix = "schedule" + String(i);
    for (int d = 0; d < 7; d++) {
      schedules[i].days[d] = prefs.getBool((prefix + "day" + String(d)).c_str(), true);
    }
  }
  prefs.end();
}

// --- Aktualizacja stanu przeka≈∫nika ---
void updateRelayState(struct tm &timeinfo) {
  if (manualOverride) return;

  int hour = timeinfo.tm_hour;
  int minute = timeinfo.tm_min;
  int weekday = timeinfo.tm_wday;
  int adjustedWeekday = (weekday == 0) ? 6 : weekday - 1;

  bool wlacz = false;
  for (int i = 0; i < 2; i++) {
    if (!schedules[i].days[adjustedWeekday]) continue;

    bool isActive = false;

    if (schedules[i].onHour < schedules[i].offHour ||
        (schedules[i].onHour == schedules[i].offHour && schedules[i].onMinute < schedules[i].offMinute)) {
      if ((hour > schedules[i].onHour || (hour == schedules[i].onHour && minute >= schedules[i].onMinute)) &&
          (hour < schedules[i].offHour || (hour == schedules[i].offHour && minute < schedules[i].offMinute))) {
        isActive = true;
      }
    } else {
      if ((hour > schedules[i].onHour || (hour == schedules[i].onHour && minute >= schedules[i].onMinute)) ||
          (hour < schedules[i].offHour || (hour == schedules[i].offHour && minute < schedules[i].offMinute))) {
        isActive = true;
      }
    }
    if (isActive) {
      wlacz = true;
      break;
    }
  }

  if (relayState != wlacz) {
    relayState = wlacz;
    digitalWrite(relayPin, relayState ? LOW : HIGH);
  }
}

// --- Aktualizacja czasu NTP ---
bool updateTime() {
  struct tm timeinfo;
  if (getLocalTime(&timeinfo)) {
    updateRelayState(timeinfo);
    return true;
  }
  return false;
}

// --- Strona WWW ---
void handleRoot() {
  String html = "<!DOCTYPE html><html><head><meta charset='UTF-8'><title>Sterownik CO</title>";
  html += "<meta http-equiv='refresh' content='60'>";
  html += "<style>.status{font-weight:bold;padding:5px 10px;border-radius:5px;color:white;}.on{background-color:green;}.off{background-color:red;}</style></head><body>";
  
  html += "<h1>Ustawienia CO</h1>";

  // üî• Dodana informacja o trybie pracy
  if(isAPMode) {
    html += "<p><b>Tryb:</b> Access Point (AP)<br>Adres: 192.168.4.1</p>";
  } else {
    html += "<p><b>Tryb:</b> Po≈ÇƒÖczony z WiFi (STA)<br>Adres: " + WiFi.localIP().toString() + "</p>";
  }

  html += "<form action='/save' method='POST'>";
  String dayNames[] = {"Pon","Wt","≈ör","Czw","Pt","Sob","Nie"};
  for(int i=0;i<2;i++){
    html += "<h3>Harmonogram "+String(i+1)+"</h3>";
    html += "W≈ÇƒÖcz: <input type='number' name='onHour"+String(i)+"' min='0' max='23' value='"+String(schedules[i].onHour)+"'>:";
    html += "<input type='number' name='onMinute"+String(i)+"' min='0' max='59' value='"+String(schedules[i].onMinute)+"'><br>";
    html += "Wy≈ÇƒÖcz: <input type='number' name='offHour"+String(i)+"' min='0' max='23' value='"+String(schedules[i].offHour)+"'>:";
    html += "<input type='number' name='offMinute"+String(i)+"' min='0' max='59' value='"+String(schedules[i].offMinute)+"'><br>Dni:";
    for(int d=0;d<7;d++){
      html += "<input type='checkbox' name='day"+String(i)+"_"+String(d)+"' value='1'"+(schedules[i].days[d]?" checked":"")+">"+dayNames[d]+" ";
    }
    html += "<br>";
  }
  html += "<input type='submit' value='Zapisz'></form><br>";

  struct tm timeinfo;
  if(getLocalTime(&timeinfo)){
    char buffer[16]; strftime(buffer,sizeof(buffer),"%H:%M:%S",&timeinfo);
    html += "<p><b>Aktualny czas:</b> "+String(buffer)+"</p>";
  }

  html += "<h3>Stan przeka≈∫nika:</h3>";
  html += "<span class='status "+String(relayState?"on":"off")+"'>"+String(relayState?"W≈ÅƒÑCZONY":"WY≈ÅƒÑCZONY")+"</span><br><br>";

  html += "<h3>Rƒôczne sterowanie:</h3><form action='/manual' method='POST'>";
  html += "<input type='submit' name='action' value='W≈ÇƒÖcz'> ";
  html += "<input type='submit' name='action' value='Wy≈ÇƒÖcz'> ";
  html += "<input type='submit' name='action' value='Automatyczny'>";
  html += "</form>";

  html += "</body></html>";
  server.send(200,"text/html",html);
}

// --- Obs≈Çuga zapisu ---
void handleSave(){
  for(int i=0;i<2;i++){
    schedules[i].onHour = server.arg("onHour"+String(i)).toInt();
    schedules[i].onMinute = server.arg("onMinute"+String(i)).toInt();
    schedules[i].offHour = server.arg("offHour"+String(i)).toInt();
    schedules[i].offMinute = server.arg("offMinute"+String(i)).toInt();
    for(int d=0;d<7;d++){
      String key="day"+String(i)+"_"+String(d);
      schedules[i].days[d]=server.hasArg(key)&&server.arg(key)=="1";
    }
  }
  saveSettings();
  server.sendHeader("Location","/");
  server.send(303);
}

// --- Obs≈Çuga rƒôczna ---
void handleManual(){
  String action = server.arg("action");
  if(action=="W≈ÇƒÖcz"){relayState=true;manualOverride=true;}
  else if(action=="Wy≈ÇƒÖcz"){relayState=false;manualOverride=true;}
  else if(action=="Automatyczny"){manualOverride=false;}
  digitalWrite(relayPin, relayState ? LOW : HIGH);
  server.sendHeader("Location","/");
  server.send(303);
}

void setup() {
  Serial.begin(115200);
  pinMode(relayPin,OUTPUT);
  relayState=false;
  manualOverride=false;
  digitalWrite(relayPin,HIGH);

  loadSettings();

  wifiMulti.addAP("ASUS HACKER", "Dom1111111");
  wifiMulti.addAP("Tenda_C8C650", "Dom1111111");

  Serial.println("≈ÅƒÖczenie z WiFi...");
  unsigned long wifiTimeout = millis()+30000;
  while(wifiMulti.run()!=WL_CONNECTED && millis()<wifiTimeout){
    delay(500);
    Serial.print(".");
  }
  Serial.println();

  if(WiFi.status()==WL_CONNECTED){
    Serial.println("Po≈ÇƒÖczono z WiFi, IP: "+WiFi.localIP().toString());
    isAPMode = false;
  } else {
    Serial.println("Nie uda≈Ço siƒô po≈ÇƒÖczyƒá z WiFi!");
    Serial.println("Uruchamiam tryb Access Point...");
    WiFi.softAP("ESP32-CO", "12345678");
    Serial.println("ESP32 dzia≈Ça jako AP. SSID: ESP32-CO, has≈Ço: 12345678");
    Serial.println("Adres do wej≈õcia: 192.168.4.1");
    isAPMode = true;
  }

  configTime(gmtOffset_sec,daylightOffset_sec,ntpServer);

  Serial.println("Czekam na synchronizacjƒô czasu NTP...");
  unsigned long startWait = millis();
  while(!updateTime() && millis()-startWait<15000){
    delay(500); Serial.print(".");
  }
  Serial.println("\nGotowe. Przeka≈∫nik sterowany wed≈Çug harmonogramu.");

  server.on("/", handleRoot);
  server.on("/save", HTTP_POST, handleSave);
  server.on("/manual", HTTP_POST, handleManual);
  server.begin();
}

void loop() {
  server.handleClient();
  if(WiFi.status()!=WL_CONNECTED){wifiMulti.run();}
  if(!manualOverride && millis()-lastNtpSync>ntpInterval){
    if(updateTime()){lastNtpSync=millis();}
  }
}
